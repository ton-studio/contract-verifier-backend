services:
  # Testnet verifier instance
  verifier-testnet:
    build: .
    container_name: contract-verifier-testnet
    restart: unless-stopped
    ports:
      - "3003:3003"
    depends_on:
      - valkey
    volumes:
      - ./src:/app/src
    environment:
      - NODE_ENV=production
      - PORT=3003
      - NETWORK=testnet
      - SOURCES_REGISTRY=${TESTNET_SOURCES_REGISTRY:-${SOURCES_REGISTRY}}
      - VERIFIER_ID=${TESTNET_VERIFIER_ID:-${VERIFIER_ID}-testnet}
      - IPFS_PROVIDER=${TESTNET_IPFS_PROVIDER:-${IPFS_PROVIDER:-dweb.link}}
      - IPFS_STORAGE_PROVIDER=${TESTNET_IPFS_STORAGE_PROVIDER:-${IPFS_STORAGE_PROVIDER:-infura}}
      - INFURA_ID=${TESTNET_INFURA_ID:-${INFURA_ID}}
      - INFURA_SECRET=${TESTNET_INFURA_SECRET:-${INFURA_SECRET}}
      - PINATA_JWT=${TESTNET_PINATA_JWT:-${PINATA_JWT}}
      - PINATA_GATEWAY=${TESTNET_PINATA_GATEWAY:-${PINATA_GATEWAY:-gateway.pinata.cloud}}
      - TACT_DEPLOYER_INFURA_ID=${TESTNET_TACT_DEPLOYER_INFURA_ID:-${TACT_DEPLOYER_INFURA_ID}}
      - TACT_DEPLOYER_INFURA_SECRET=${TESTNET_TACT_DEPLOYER_INFURA_SECRET:-${TACT_DEPLOYER_INFURA_SECRET}}
      - TACT_DEPLOYER_PINATA_JWT=${TESTNET_TACT_DEPLOYER_PINATA_JWT:-${TACT_DEPLOYER_PINATA_JWT}}
      - TACT_DEPLOYER_PINATA_GATEWAY=${TESTNET_TACT_DEPLOYER_PINATA_GATEWAY:-${TACT_DEPLOYER_PINATA_GATEWAY:-gateway.pinata.cloud}}
      - PRIVATE_KEY=${TESTNET_PRIVATE_KEY:-${PRIVATE_KEY}}
      - STORAGE_PROVIDER=${TESTNET_STORAGE_PROVIDER:-valkey}
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:-}
      - VALKEY_DB=0
      - COMPILE_TIMEOUT=${COMPILE_TIMEOUT:-5000}
      - LEGACY_FUNC_COMPILER=${LEGACY_FUNC_COMPILER:-false}
      - ALLOW_REVERIFICATION=${TESTNET_ALLOW_REVERIFICATION:-${ALLOW_REVERIFICATION:-}}
      - DISABLE_RM=${DISABLE_RM:-}

  # Mainnet verifier instance
  verifier-mainnet-1:
    build: .
    container_name: contract-verifier-mainnet-1
    restart: unless-stopped
    ports:
      - "3004:3004"
    depends_on:
      - valkey
    volumes:
      - ./src:/app/src
    environment:
      - NODE_ENV=production
      - PORT=3004
      - NETWORK=mainnet
      - SOURCES_REGISTRY=${MAINNET_SOURCES_REGISTRY:-${SOURCES_REGISTRY}}
      - VERIFIER_ID=${MAINNET_VERIFIER_ID:-${VERIFIER_ID}-mainnet}
      - IPFS_PROVIDER=${MAINNET_IPFS_PROVIDER:-${IPFS_PROVIDER:-dweb.link}}
      - IPFS_STORAGE_PROVIDER=${MAINNET_IPFS_STORAGE_PROVIDER:-${IPFS_STORAGE_PROVIDER:-infura}}
      - INFURA_ID=${MAINNET_INFURA_ID:-${INFURA_ID}}
      - INFURA_SECRET=${MAINNET_INFURA_SECRET:-${INFURA_SECRET}}
      - PINATA_JWT=${MAINNET_PINATA_JWT:-${PINATA_JWT}}
      - PINATA_GATEWAY=${MAINNET_PINATA_GATEWAY:-${PINATA_GATEWAY:-gateway.pinata.cloud}}
      - TACT_DEPLOYER_INFURA_ID=${MAINNET_TACT_DEPLOYER_INFURA_ID:-${TACT_DEPLOYER_INFURA_ID}}
      - TACT_DEPLOYER_INFURA_SECRET=${MAINNET_TACT_DEPLOYER_INFURA_SECRET:-${TACT_DEPLOYER_INFURA_SECRET}}
      - TACT_DEPLOYER_PINATA_JWT=${MAINNET_TACT_DEPLOYER_PINATA_JWT:-${TACT_DEPLOYER_PINATA_JWT}}
      - TACT_DEPLOYER_PINATA_GATEWAY=${MAINNET_TACT_DEPLOYER_PINATA_GATEWAY:-${TACT_DEPLOYER_PINATA_GATEWAY:-gateway.pinata.cloud}}
      - PRIVATE_KEY=${MAINNET_PRIVATE_KEY:-${PRIVATE_KEY}}
      - STORAGE_PROVIDER=${MAINNET_STORAGE_PROVIDER:-valkey}
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:-}
      - VALKEY_DB=1
      - COMPILE_TIMEOUT=${COMPILE_TIMEOUT:-5000}
      - LEGACY_FUNC_COMPILER=${LEGACY_FUNC_COMPILER:-false}
      - ALLOW_REVERIFICATION=${MAINNET_ALLOW_REVERIFICATION:-${ALLOW_REVERIFICATION:-}}
      - DISABLE_RM=${DISABLE_RM:-}
  verifier-mainnet-2:
    build: .
    container_name: contract-verifier-mainnet-2
    restart: unless-stopped
    ports:
      - "3005:3005"
    depends_on:
      - valkey
    volumes:
      - ./src:/app/src
    environment:
      - NODE_ENV=production
      - PORT=3005
      - NETWORK=mainnet
      - SOURCES_REGISTRY=${MAINNET_SOURCES_REGISTRY:-${SOURCES_REGISTRY}}
      - VERIFIER_ID=${MAINNET_VERIFIER_ID:-${VERIFIER_ID}-mainnet}
      - IPFS_PROVIDER=${MAINNET_IPFS_PROVIDER:-${IPFS_PROVIDER:-dweb.link}}
      - IPFS_STORAGE_PROVIDER=${MAINNET_IPFS_STORAGE_PROVIDER:-${IPFS_STORAGE_PROVIDER:-infura}}
      - INFURA_ID=${MAINNET_INFURA_ID:-${INFURA_ID}}
      - INFURA_SECRET=${MAINNET_INFURA_SECRET:-${INFURA_SECRET}}
      - PINATA_JWT=${MAINNET_PINATA_JWT:-${PINATA_JWT}}
      - PINATA_GATEWAY=${MAINNET_PINATA_GATEWAY:-${PINATA_GATEWAY:-gateway.pinata.cloud}}
      - TACT_DEPLOYER_INFURA_ID=${MAINNET_TACT_DEPLOYER_INFURA_ID:-${TACT_DEPLOYER_INFURA_ID}}
      - TACT_DEPLOYER_INFURA_SECRET=${MAINNET_TACT_DEPLOYER_INFURA_SECRET:-${TACT_DEPLOYER_INFURA_SECRET}}
      - TACT_DEPLOYER_PINATA_JWT=${MAINNET_TACT_DEPLOYER_PINATA_JWT:-${TACT_DEPLOYER_PINATA_JWT}}
      - TACT_DEPLOYER_PINATA_GATEWAY=${MAINNET_TACT_DEPLOYER_PINATA_GATEWAY:-${TACT_DEPLOYER_PINATA_GATEWAY:-gateway.pinata.cloud}}
      - PRIVATE_KEY=${MAINNET_PRIVATE_KEY:-${PRIVATE_KEY}}
      - STORAGE_PROVIDER=${MAINNET_STORAGE_PROVIDER:-valkey}
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:-}
      - VALKEY_DB=1
      - COMPILE_TIMEOUT=${COMPILE_TIMEOUT:-5000}
      - LEGACY_FUNC_COMPILER=${LEGACY_FUNC_COMPILER:-false}
      - ALLOW_REVERIFICATION=${MAINNET_ALLOW_REVERIFICATION:-${ALLOW_REVERIFICATION:-}}
      - DISABLE_RM=${DISABLE_RM:-}
  verifier-mainnet-3:
    build: .
    container_name: contract-verifier-mainnet-3
    restart: unless-stopped
    ports:
      - "3006:3006"
    depends_on:
      - valkey
    volumes:
      - ./src:/app/src
    environment:
      - NODE_ENV=production
      - PORT=3006
      - NETWORK=mainnet
      - SOURCES_REGISTRY=${MAINNET_SOURCES_REGISTRY:-${SOURCES_REGISTRY}}
      - VERIFIER_ID=${MAINNET_VERIFIER_ID:-${VERIFIER_ID}-mainnet}
      - IPFS_PROVIDER=${MAINNET_IPFS_PROVIDER:-${IPFS_PROVIDER:-dweb.link}}
      - IPFS_STORAGE_PROVIDER=${MAINNET_IPFS_STORAGE_PROVIDER:-${IPFS_STORAGE_PROVIDER:-infura}}
      - INFURA_ID=${MAINNET_INFURA_ID:-${INFURA_ID}}
      - INFURA_SECRET=${MAINNET_INFURA_SECRET:-${INFURA_SECRET}}
      - PINATA_JWT=${MAINNET_PINATA_JWT:-${PINATA_JWT}}
      - PINATA_GATEWAY=${MAINNET_PINATA_GATEWAY:-${PINATA_GATEWAY:-gateway.pinata.cloud}}
      - TACT_DEPLOYER_INFURA_ID=${MAINNET_TACT_DEPLOYER_INFURA_ID:-${TACT_DEPLOYER_INFURA_ID}}
      - TACT_DEPLOYER_INFURA_SECRET=${MAINNET_TACT_DEPLOYER_INFURA_SECRET:-${TACT_DEPLOYER_INFURA_SECRET}}
      - TACT_DEPLOYER_PINATA_JWT=${MAINNET_TACT_DEPLOYER_PINATA_JWT:-${TACT_DEPLOYER_PINATA_JWT}}
      - TACT_DEPLOYER_PINATA_GATEWAY=${MAINNET_TACT_DEPLOYER_PINATA_GATEWAY:-${TACT_DEPLOYER_PINATA_GATEWAY:-gateway.pinata.cloud}}
      - PRIVATE_KEY=${MAINNET_PRIVATE_KEY:-${PRIVATE_KEY}}
      - STORAGE_PROVIDER=${MAINNET_STORAGE_PROVIDER:-valkey}
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:-}
      - VALKEY_DB=1
      - COMPILE_TIMEOUT=${COMPILE_TIMEOUT:-5000}
      - LEGACY_FUNC_COMPILER=${LEGACY_FUNC_COMPILER:-false}
      - ALLOW_REVERIFICATION=${MAINNET_ALLOW_REVERIFICATION:-${ALLOW_REVERIFICATION:-}}
      - DISABLE_RM=${DISABLE_RM:-}

  # Shared Valkey instance (separate DBs for testnet and mainnet)
  valkey:
    image: valkey/valkey:7.2-alpine
    container_name: contract-verifier-valkey
    ports:
      - "6379:6379"
    restart: unless-stopped
    volumes:
      - valkey-data:/data
    command: valkey-server --save 60 1 --loglevel notice --databases 16

volumes:
  valkey-data:
    driver: local
